<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M√º≈üteriler - Envanter Sistemi</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="/app.js"></script>
</head>

<body class="bg-light">
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/dashboard.html">üìä Envanter Sistemi</a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/dashboard.html">üè† Ana Sayfa</a>
                <a class="nav-link" href="#" onclick="logout()">üö™ √áƒ±kƒ±≈ü</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h3">üë• M√º≈üteriler</h1>
            <div class="d-flex gap-2">
                <input type="text" id="searchInput" class="form-control"
                    placeholder="√únvan, telefon veya e-posta ara..." style="width: 300px;">
                <button class="btn btn-primary" onclick="loadCustomers()">üîç Ara</button>
                <button id="btnAdd" class="btn btn-success" onclick="showAddModal()">‚ûï Yeni M√º≈üteri</button>
            </div>
        </div>

        <div id="errorMessage" style="display: none;"></div>
        <div id="successMessage" style="display: none;"></div>

        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>ID</th>
                                <th>√únvan</th>
                                <th>Telefon</th>
                                <th>E-posta</th>
                                <th>Adres</th>
                                <th>Aktif</th>
                                <th>ƒ∞≈ülemler</th>
                            </tr>
                        </thead>
                        <tbody id="customerTableBody">
                            <!-- Dinamik i√ßerik -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Modal -->
    <div class="modal fade" id="customerModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">Yeni M√º≈üteri</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="customerForm">
                    <div class="modal-body">
                        <input type="hidden" id="customerId">
                        <div class="mb-3">
                            <label for="unvan" class="form-label">√únvan *</label>
                            <input type="text" class="form-control" id="unvan" required>
                        </div>
                        <div class="mb-3">
                            <label for="vergi_no" class="form-label">Vergi No</label>
                            <input type="text" class="form-control" id="vergi_no">
                        </div>
                        <div class="mb-3">
                            <label for="telefon" class="form-label">Telefon</label>
                            <input type="text" class="form-control" id="telefon">
                        </div>
                        <div class="mb-3">
                            <label for="eposta" class="form-label">E-posta</label>
                            <input type="email" class="form-control" id="eposta">
                        </div>
                        <div class="mb-3">
                            <label for="adres" class="form-label">Adres</label>
                            <textarea class="form-control" id="adres" rows="3"></textarea>
                        </div>
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="aktif" checked>
                            <label class="form-check-label" for="aktif">Aktif</label>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒ∞ptal</button>
                        <button type="submit" class="btn btn-primary">Kaydet</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        if (!checkAuth()) {
            window.location.href = '/login.html';
        }

        // Admin kontrol√º
        const isAdmin = getRole() === 'admin';
        if (!isAdmin) {
            showIfAdmin(document.getElementById('btnAdd'));
        }

        let customers = [];
        const customerModal = new bootstrap.Modal(document.getElementById('customerModal'));

        // Sayfa y√ºklendiƒüinde m√º≈üterileri getir
        loadCustomers();

        async function loadCustomers() {
            try {
                clearMessages();
                const searchTerm = document.getElementById('searchInput').value;
                const response = await apiFetch(`/api/musteriler?q=${encodeURIComponent(searchTerm)}`);

                if (!response.ok) {
                    throw new Error('M√º≈üteriler y√ºklenemedi');
                }

                customers = await response.json();
                renderCustomersTable();
            } catch (error) {
                showError('M√º≈üteriler y√ºklenirken hata: ' + error.message);
            }
        }

        function renderCustomersTable() {
            const tbody = document.getElementById('customerTableBody');

            if (customers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">M√º≈üteri bulunamadƒ±</td></tr>';
                return;
            }

            tbody.innerHTML = customers.map(customer => {
                const actions = isAdmin ? `
                    <button class="btn btn-sm btn-outline-primary" onclick="editCustomer(${customer.id})">
                        ‚úèÔ∏è D√ºzenle
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteCustomer(${customer.id})">
                        üóëÔ∏è Sil
                    </button>
                ` : '<span class="text-muted">Yetki yok</span>';

                return `
                    <tr>
                        <td>${customer.id}</td>
                        <td><strong>${customer.unvan}</strong></td>
                        <td>${customer.telefon || '-'}</td>
                        <td>${customer.eposta || '-'}</td>
                        <td>${customer.adres || '-'}</td>
                        <td>
                            <span class="badge bg-${customer.aktif ? 'success' : 'secondary'}">
                                ${customer.aktif ? 'Aktif' : 'Pasif'}
                            </span>
                        </td>
                        <td>${actions}</td>
                    </tr>
                `;
            }).join('');
        }

        function showAddModal() {
            if (!isAdmin) {
                alert('Bu i≈ülem i√ßin admin yetkisi gerekli');
                return;
            }

            document.getElementById('modalTitle').textContent = 'Yeni M√º≈üteri';
            document.getElementById('customerForm').reset();
            document.getElementById('customerId').value = '';
            document.getElementById('aktif').checked = true;
            customerModal.show();
        }

        function editCustomer(id) {
            if (!isAdmin) {
                alert('Bu i≈ülem i√ßin admin yetkisi gerekli');
                return;
            }

            const customer = customers.find(c => c.id === id);
            if (!customer) return;

            document.getElementById('modalTitle').textContent = 'M√º≈üteriyi D√ºzenle';
            document.getElementById('customerId').value = customer.id;
            document.getElementById('unvan').value = customer.unvan;
            document.getElementById('vergi_no').value = customer.vergi_no || '';
            document.getElementById('telefon').value = customer.telefon || '';
            document.getElementById('eposta').value = customer.eposta || '';
            document.getElementById('adres').value = customer.adres || '';
            document.getElementById('aktif').checked = customer.aktif;
            customerModal.show();
        }

        async function deleteCustomer(id) {
            if (!isAdmin) {
                alert('Bu i≈ülem i√ßin admin yetkisi gerekli');
                return;
            }

            if (!confirm('Bu m√º≈üteriyi silmek istediƒüinizden emin misiniz?')) return;

            try {
                const response = await apiFetch(`/api/musteriler/${id}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    throw new Error('M√º≈üteri silinemedi');
                }

                showSuccess('M√º≈üteri ba≈üarƒ±yla silindi');
                loadCustomers();
            } catch (error) {
                showError('M√º≈üteri silinirken hata: ' + error.message);
            }
        }

        // Form submit handler
        document.getElementById('customerForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!isAdmin) {
                alert('Bu i≈ülem i√ßin admin yetkisi gerekli');
                return;
            }

            const formData = {
                unvan: document.getElementById('unvan').value,
                vergi_no: document.getElementById('vergi_no').value || null,
                telefon: document.getElementById('telefon').value || null,
                eposta: document.getElementById('eposta').value || null,
                adres: document.getElementById('adres').value || null,
                aktif: document.getElementById('aktif').checked ? 1 : 0
            };

            const customerId = document.getElementById('customerId').value;
            const isEdit = customerId !== '';

            try {
                const response = await apiFetch(`/api/musteriler${isEdit ? `/${customerId}` : ''}`, {
                    method: isEdit ? 'PUT' : 'POST',
                    body: JSON.stringify(formData)
                });

                if (!response.ok) {
                    throw new Error('M√º≈üteri kaydedilemedi');
                }

                customerModal.hide();
                showSuccess(`M√º≈üteri ba≈üarƒ±yla ${isEdit ? 'g√ºncellendi' : 'eklendi'}`);
                loadCustomers();
            } catch (error) {
                showError('M√º≈üteri kaydedilirken hata: ' + error.message);
            }
        });

        // Arama input'u i√ßin enter tu≈üu desteƒüi
        document.getElementById('searchInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                loadCustomers();
            }
        });
    </script>
</body>

</html>